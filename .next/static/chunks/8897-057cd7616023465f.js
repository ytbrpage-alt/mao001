"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8897],{8605:function(e,t,s){s.d(t,{f:function(){return C}});var n=s(7437),a=s(2265),r=s(521),i=s(8614),l=s(1723),d=s(401),c=s(9196),u=s(2252),o=s(8098),m=s(2489),x=s(6980),h=s(4743),p=s(4122),f=s(817),v=s(3442),g=s(4862),j=s(7066),b=s(4362),N=s(1001);function w(e){let t,{message:s,isOwn:a,showAvatar:r,onReply:i}=e;return s.deletedAt?(0,n.jsx)("div",{className:(0,N.cn)("flex mb-2",a?"justify-end":"justify-start"),children:(0,n.jsx)("div",{className:"italic text-neutral-400 text-sm px-4 py-2",children:"Mensagem removida"})}):(0,n.jsxs)("div",{className:(0,N.cn)("flex gap-2 mb-2 group",a?"flex-row-reverse":"flex-row"),children:[r&&!a?(0,n.jsx)("div",{className:"w-8 h-8 rounded-full bg-brand-100 flex items-center justify-center text-brand-600 text-xs font-medium flex-shrink-0",children:s.senderAvatar?(0,n.jsx)("img",{src:s.senderAvatar,alt:"",className:"w-full h-full rounded-full object-cover"}):s.senderName.split(" ").map(e=>e[0]).slice(0,2).join("")}):(0,n.jsx)("div",{className:"w-8 flex-shrink-0"}),(0,n.jsxs)("div",{className:(0,N.cn)("max-w-[75%] rounded-2xl px-4 py-2 relative",a?"bg-brand-500 text-white rounded-br-md":"bg-white text-neutral-900 rounded-bl-md shadow-soft"),children:[r&&!a&&(0,n.jsx)("p",{className:"text-xs font-medium text-brand-600 mb-1",children:s.senderName}),s.replyTo&&(0,n.jsxs)("div",{className:(0,N.cn)("text-xs p-2 rounded-t-lg border-l-2 mb-1",a?"bg-brand-600 border-white/50 text-white/80":"bg-neutral-100 border-neutral-400 text-neutral-600"),children:[(0,n.jsx)("p",{className:"font-medium",children:s.replyTo.senderName}),(0,n.jsx)("p",{className:"truncate",children:s.replyTo.content})]}),(0,n.jsxs)("div",{children:["text"===s.type&&(0,n.jsx)("p",{className:"break-words whitespace-pre-wrap",children:s.content}),"image"===s.type&&s.mediaUrl&&(0,n.jsx)("img",{src:s.mediaUrl,alt:"",className:"rounded-lg max-w-full"}),(0,n.jsxs)("div",{className:"flex items-center justify-end gap-1 mt-1",children:[(0,n.jsx)("span",{className:(0,N.cn)("text-xs",a?"text-white/70":"text-neutral-400"),children:(t=s.createdAt,(0,p.WU)(new Date(t),"HH:mm"))}),a&&(e=>{switch(e){case"sending":return(0,n.jsx)(l.Z,{className:"w-3 h-3"});case"sent":return(0,n.jsx)(d.Z,{className:"w-3 h-3"});case"delivered":return(0,n.jsx)(c.Z,{className:"w-3 h-3"});case"read":return(0,n.jsx)(c.Z,{className:"w-3 h-3 text-blue-400"});case"failed":return(0,n.jsx)(u.Z,{className:"w-3 h-3 text-red-400"})}})(s.status)]})]}),(0,n.jsx)("div",{className:"absolute -top-2 right-0 hidden group-hover:block",children:(0,n.jsx)("button",{onClick:()=>i(s),className:"p-1.5 bg-white rounded-full shadow-md hover:bg-neutral-50",title:"Responder",children:(0,n.jsx)(o.Z,{className:"w-3 h-3 text-neutral-600"})})})]})]})}function y(e){let{date:t}=e;return(0,n.jsxs)("div",{className:"flex items-center gap-4 my-4",children:[(0,n.jsx)("div",{className:"flex-1 h-px bg-neutral-200"}),(0,n.jsx)("span",{className:"text-xs text-neutral-500 font-medium",children:(0,f.z)(t)?"Hoje":(0,v.g)(t)?"Ontem":(0,p.WU)(t,"dd 'de' MMMM",{locale:g.F})}),(0,n.jsx)("div",{className:"flex-1 h-px bg-neutral-200"})]})}function A(e){let{names:t}=e;if(0===t.length)return null;let s=1===t.length?"".concat(t[0]," est\xe1 digitando..."):2===t.length?"".concat(t[0]," e ").concat(t[1]," est\xe3o digitando..."):"".concat(t[0]," e mais ").concat(t.length-1," est\xe3o digitando...");return(0,n.jsxs)(r.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex items-center gap-2 text-sm text-neutral-500 px-4 py-2",children:[(0,n.jsxs)("div",{className:"flex gap-1",children:[(0,n.jsx)(r.E.span,{animate:{opacity:[.4,1,.4]},transition:{duration:1.4,repeat:1/0,delay:0},className:"w-2 h-2 bg-neutral-400 rounded-full"}),(0,n.jsx)(r.E.span,{animate:{opacity:[.4,1,.4]},transition:{duration:1.4,repeat:1/0,delay:.2},className:"w-2 h-2 bg-neutral-400 rounded-full"}),(0,n.jsx)(r.E.span,{animate:{opacity:[.4,1,.4]},transition:{duration:1.4,repeat:1/0,delay:.4},className:"w-2 h-2 bg-neutral-400 rounded-full"})]}),(0,n.jsx)("span",{children:s})]})}function C(e){let{conversationId:t}=e,{user:s}=(0,b.aC)(),{getConversation:l,getMessages:d,sendMessage:c,markAsRead:u,setTyping:f,isTyping:v}=(0,j.a)(),[g,N]=(0,a.useState)(""),[C,M]=(0,a.useState)(null),k=(0,a.useRef)(null),I=(0,a.useRef)(null),D=(0,a.useRef)(),E=l(t),T=d(t),S=v[t]||[],Z=(0,a.useCallback)(()=>{var e;null===(e=k.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[]);(0,a.useEffect)(()=>{(null==s?void 0:s.id)&&t&&u(t,s.id)},[t,null==s?void 0:s.id,u]),(0,a.useEffect)(()=>{Z()},[T.length,Z]);let R=(0,a.useCallback)(()=>{(null==s?void 0:s.id)&&(f(t,s.id,!0),D.current&&clearTimeout(D.current),D.current=setTimeout(()=>{f(t,s.id,!1)},2e3))},[t,null==s?void 0:s.id,f]),L=(0,a.useCallback)(()=>{var e;g.trim()&&s&&(c(t,s.id,s.fullName,s.role||"user",g.trim(),"text",C||void 0),N(""),M(null),f(t,s.id,!1),null===(e=I.current)||void 0===e||e.focus())},[g,s,t,C,c,f]),U=T.reduce((e,t)=>{let s=(0,p.WU)(new Date(t.createdAt),"yyyy-MM-dd");return e[s]||(e[s]=[]),e[s].push(t),e},{}),O=S.filter(e=>e!==(null==s?void 0:s.id)).map(e=>{let t=null==E?void 0:E.participants.find(t=>t.userId===e);return(null==t?void 0:t.userName.split(" ")[0])||"Algu\xe9m"});return E?(0,n.jsxs)("div",{className:"flex flex-col h-full",children:[(0,n.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 bg-neutral-50",children:[Object.entries(U).map(e=>{let[t,a]=e;return(0,n.jsxs)("div",{children:[(0,n.jsx)(y,{date:new Date(t)}),a.map((e,t)=>{let r=a[t-1],i=!r||r.senderId!==e.senderId||new Date(e.createdAt).getTime()-new Date(r.createdAt).getTime()>6e4;return(0,n.jsx)(w,{message:e,isOwn:e.senderId===(null==s?void 0:s.id),showAvatar:i,onReply:M},e.id)})]},t)}),(0,n.jsx)(i.M,{children:O.length>0&&(0,n.jsx)(A,{names:O})}),(0,n.jsx)("div",{ref:k})]}),(0,n.jsx)(i.M,{children:C&&(0,n.jsx)(r.E.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"bg-brand-50 border-t border-brand-100",children:(0,n.jsxs)("div",{className:"flex items-center gap-3 p-3",children:[(0,n.jsxs)("div",{className:"flex-1 border-l-2 border-brand-500 pl-3",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)(o.Z,{className:"w-4 h-4 text-brand-500"}),(0,n.jsxs)("span",{className:"text-sm font-medium text-brand-600",children:["Respondendo a ",C.senderName]})]}),(0,n.jsx)("p",{className:"text-sm text-neutral-600 truncate mt-0.5",children:C.content})]}),(0,n.jsx)("button",{onClick:()=>M(null),className:"p-1 hover:bg-brand-100 rounded",children:(0,n.jsx)(m.Z,{className:"w-5 h-5 text-neutral-500"})})]})})}),(0,n.jsx)("div",{className:"p-4 bg-white border-t border-neutral-200",children:(0,n.jsxs)("div",{className:"flex items-end gap-2",children:[(0,n.jsx)("button",{className:"p-2 text-neutral-500 hover:text-neutral-700 hover:bg-neutral-100 rounded-full",children:(0,n.jsx)(x.Z,{className:"w-5 h-5"})}),(0,n.jsx)("div",{className:"flex-1",children:(0,n.jsx)("textarea",{ref:I,value:g,onChange:e=>{N(e.target.value),R()},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),L())},placeholder:"Digite uma mensagem...",className:"w-full px-4 py-2 bg-neutral-100 rounded-2xl resize-none focus:outline-none focus:ring-2 focus:ring-brand-500 max-h-32",rows:1})}),(0,n.jsx)("button",{onClick:L,disabled:!g.trim(),className:"p-2 bg-brand-500 text-white rounded-full hover:bg-brand-600 disabled:opacity-50 disabled:cursor-not-allowed",children:(0,n.jsx)(h.Z,{className:"w-5 h-5"})})]})})]}):(0,n.jsx)("div",{className:"flex-1 flex items-center justify-center text-neutral-500",children:"Conversa n\xe3o encontrada"})}},4156:function(e,t,s){s.d(t,{p:function(){return f}});var n=s(7437),a=s(2265),r=s(521),i=s(5805),l=s(9397),d=s(3247),c=s(2718),u=s(8442),o=s(4862),m=s(7066),x=s(4362),h=s(1001);function p(e){let{conversation:t,currentUserId:s,isSelected:a,onClick:l}=e,d=t.unreadCount;return(0,n.jsxs)(r.E.button,{whileTap:{scale:.98},onClick:l,className:(0,h.cn)("w-full flex items-center gap-3 p-4 hover:bg-neutral-50 transition-colors",a&&"bg-brand-50"),children:[(0,n.jsx)("div",{className:(0,h.cn)("w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0","patient_care"===t.type?"bg-purple-100 text-purple-600":"bg-brand-100 text-brand-600","text-sm font-medium"),children:(()=>{if("patient_care"===t.type)return(0,n.jsx)(i.Z,{className:"w-5 h-5"});if("direct"===t.type){let e=t.participants.find(e=>e.userId!==s);return(null==e?void 0:e.userAvatar)?(0,n.jsx)("img",{src:e.userAvatar,alt:"",className:"w-full h-full rounded-full object-cover"}):(null==e?void 0:e.userName.split(" ").map(e=>e[0]).slice(0,2).join(""))||"?"}return(0,n.jsx)(i.Z,{className:"w-5 h-5"})})()}),(0,n.jsxs)("div",{className:"flex-1 min-w-0 text-left",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,n.jsx)("p",{className:(0,h.cn)("font-medium truncate",d>0?"text-neutral-900":"text-neutral-700"),children:(()=>{if("patient_care"===t.type)return"Grupo: ".concat(t.patientName);if("direct"===t.type){let e=t.participants.find(e=>e.userId!==s);return(null==e?void 0:e.userName)||"Conversa"}return"Grupo"})()}),t.lastMessage&&(0,n.jsx)("span",{className:"text-xs text-neutral-400 flex-shrink-0",children:(0,u.Q)(new Date(t.lastMessage.timestamp),{locale:o.F,addSuffix:!1})})]}),t.lastMessage&&(0,n.jsxs)("p",{className:(0,h.cn)("text-sm truncate mt-0.5",d>0?"text-neutral-700 font-medium":"text-neutral-500"),children:[t.lastMessage.senderName.split(" ")[0],": ",t.lastMessage.content]})]}),d>0&&(0,n.jsx)("span",{className:"w-5 h-5 rounded-full bg-brand-500 text-white text-xs flex items-center justify-center flex-shrink-0",children:d>9?"9+":d})]})}function f(e){let{onSelectConversation:t,selectedId:s}=e,{user:r}=(0,x.aC)(),{getConversationsForUser:i}=(0,m.a)(),[u,o]=(0,a.useState)(""),h=(r?i(r.id):[]).filter(e=>{var t,s;if(!u)return!0;let n=u.toLowerCase();return!!((null===(t=e.patientName)||void 0===t?void 0:t.toLowerCase().includes(n))||e.participants.some(e=>e.userName.toLowerCase().includes(n))||(null===(s=e.lastMessage)||void 0===s?void 0:s.content.toLowerCase().includes(n)))});return(0,n.jsxs)("div",{className:"flex flex-col h-full bg-white",children:[(0,n.jsxs)("div",{className:"p-4 border-b border-neutral-200",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold text-neutral-900",children:"Mensagens"}),(0,n.jsx)("button",{className:"p-2 bg-brand-500 text-white rounded-full hover:bg-brand-600",children:(0,n.jsx)(l.Z,{className:"w-5 h-5"})})]}),(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsx)(d.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-400"}),(0,n.jsx)("input",{type:"text",value:u,onChange:e=>o(e.target.value),placeholder:"Buscar conversas...",className:"w-full pl-9 pr-4 py-2 bg-neutral-100 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-500"})]})]}),(0,n.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===h.length?(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-neutral-500 p-8",children:[(0,n.jsx)(c.Z,{className:"w-12 h-12 mb-3 text-neutral-300"}),(0,n.jsx)("p",{className:"text-center",children:u?"Nenhuma conversa encontrada":"Nenhuma conversa ainda"})]}):(0,n.jsx)("div",{className:"divide-y divide-neutral-100",children:h.map(e=>(0,n.jsx)(p,{conversation:e,currentUserId:(null==r?void 0:r.id)||"",isSelected:s===e.id,onClick:()=>t(e.id)},e.id))})})]})}},4362:function(e,t,s){s.d(t,{Ho:function(){return c},QL:function(){return o},aC:function(){return u}});var n=s(7437),a=s(2265),r=s(9376),i=s(4270);let l=(0,a.createContext)(null),d=["/login","/forgot-pin","/"];function c(e){let{children:t}=e,s=(0,r.useRouter)(),c=(0,r.usePathname)(),u=function(){let[e,t]=(0,a.useState)(!1);return(0,a.useEffect)(()=>{t(!0)},[]),e}(),o=(0,i.t)(),[m,x]=(0,a.useState)(!1),[h,p]=(0,a.useState)(null),[f,v]=(0,a.useState)(!1);(0,a.useEffect)(()=>{if(!u)return;let e=setTimeout(()=>{(0,i.v)().then(()=>{v(!0)})},100);return()=>clearTimeout(e)},[u]),(0,a.useEffect)(()=>{if(!f)return;let e=()=>{if(!o.checkSession()&&!d.includes(c)){s.push("/login");return}if(o.session){let e=new Date(o.session.expiresAt).getTime()-Date.now();p(e),x(e>0&&e<3e5)}};e();let t=setInterval(e,3e4);return()=>clearInterval(t)},[f,c,s,o]),(0,a.useEffect)(()=>{if(!o.isAuthenticated)return;let e=()=>{o.recordActivity()},t=["mousedown","keydown","touchstart","scroll"];return t.forEach(t=>{window.addEventListener(t,e,{passive:!0})}),()=>{t.forEach(t=>{window.removeEventListener(t,e)})}},[o.isAuthenticated,o]),(0,a.useEffect)(()=>{if(!f)return;let e=d.includes(c);o.isAuthenticated||e?o.isAuthenticated&&"/login"===c&&s.push("/"):s.push("/login")},[f,o.isAuthenticated,c,s]);let g=(0,a.useCallback)(async e=>{let t=await o.loginWithPin(e);return t.success&&s.push("/"),t},[o,s]),j=(0,a.useCallback)(()=>{o.logout(),s.push("/login")},[o,s]),b=(0,a.useCallback)(()=>{o.refreshSession(),x(!1)},[o]),N=(0,a.useCallback)(e=>o.hasPermission(e),[o]),w={user:o.getCurrentUser(),isAuthenticated:o.isAuthenticated,isLoading:!f,permissions:o.getPermissions(),login:g,logout:j,hasPermission:N,showSessionWarning:m,sessionExpiresIn:h,extendSession:b};return(0,n.jsx)(l.Provider,{value:w,children:t})}function u(){let e=(0,a.useContext)(l);if(!e)throw Error("useAuth deve ser usado dentro de AuthProvider");return e}function o(e){let{isAuthenticated:t,isLoading:s,hasPermission:n}=u(),i=(0,r.useRouter)();return(0,a.useEffect)(()=>{if(!s){if(!t){i.push("/login");return}e&&!n(e)&&i.push("/unauthorized")}},[t,s,e,n,i]),{isLoading:s,isAuthorized:t&&(!e||n(e))}}},1001:function(e,t,s){s.d(t,{cn:function(){return r}});var n=s(1994),a=s(3335);function r(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return(0,a.m6)((0,n.W)(t))}},7066:function(e,t,s){s.d(t,{a:function(){return i}});var n=s(9625),a=s(6885),r=s(9360);let i=(0,n.Ue)()((0,a.tJ)((e,t)=>({conversations:{},messages:{},activeConversationId:null,isLoading:!1,isTyping:{},createConversation:(t,s,n,a)=>{let i=(0,r.Z)(),l=new Date,d={id:i,type:t,patientId:n,patientName:a,participants:s.map(e=>{var t,s,n;return{...e,joinedAt:l,isAdmin:null!==(t=e.isAdmin)&&void 0!==t&&t,canSendMessages:null===(s=e.canSendMessages)||void 0===s||s,notifications:null===(n=e.notifications)||void 0===n||n}}),unreadCount:0,totalMessages:0,isArchived:!1,isMuted:!1,createdAt:l,updatedAt:l};return e(e=>({conversations:{...e.conversations,[i]:d},messages:{...e.messages,[i]:[]}})),i},getOrCreateDirectConversation:(e,s,n,a,r,i)=>{let{conversations:l}=t(),d=Object.values(l).find(t=>"direct"===t.type&&2===t.participants.length&&t.participants.some(t=>t.userId===e)&&t.participants.some(e=>e.userId===a));return d?d.id:t().createConversation("direct",[{userId:e,userName:s,userRole:n,isAdmin:!1,canSendMessages:!0,notifications:!0},{userId:a,userName:r,userRole:i,isAdmin:!1,canSendMessages:!0,notifications:!0}])},archiveConversation:t=>{e(e=>({conversations:{...e.conversations,[t]:{...e.conversations[t],isArchived:!0,updatedAt:new Date}}}))},unarchiveConversation:t=>{e(e=>({conversations:{...e.conversations,[t]:{...e.conversations[t],isArchived:!1,updatedAt:new Date}}}))},muteConversation:(t,s)=>{e(e=>({conversations:{...e.conversations,[t]:{...e.conversations[t],isMuted:!0,mutedUntil:s,updatedAt:new Date}}}))},unmuteConversation:t=>{e(e=>({conversations:{...e.conversations,[t]:{...e.conversations[t],isMuted:!1,mutedUntil:void 0,updatedAt:new Date}}}))},sendMessage:function(t,s,n,a,i){let l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"text",d=arguments.length>6?arguments[6]:void 0,c=(0,r.Z)(),u=new Date,o={id:c,conversationId:t,senderId:s,senderName:n,senderRole:a,type:l,content:i,status:"sent",readBy:[{userId:s,readAt:u}],replyTo:d?{messageId:d.id,content:d.content.substring(0,100),senderName:d.senderName}:void 0,createdAt:u,updatedAt:u};return e(e=>{let s=e.messages[t]||[],a=e.conversations[t];return{messages:{...e.messages,[t]:[...s,o]},conversations:{...e.conversations,[t]:{...a,lastMessage:{content:"text"===l?i:"[".concat(l,"]"),senderName:n,timestamp:u,type:l},totalMessages:a.totalMessages+1,unreadCount:a.unreadCount+(a.participants.length-1),updatedAt:u}}}}),c},updateMessageStatus:(t,s,n)=>{e(e=>{var a;return{messages:{...e.messages,[t]:(null===(a=e.messages[t])||void 0===a?void 0:a.map(e=>e.id===s?{...e,status:n,updatedAt:new Date}:e))||[]}}})},markAsRead:(t,s)=>{let n=new Date;e(e=>{let a=e.messages[t]||[],r=e.conversations[t];if(!r)return e;let i=a.map(e=>e.senderId===s||e.readBy.some(e=>e.userId===s)?e:{...e,readBy:[...e.readBy,{userId:s,readAt:n}],status:"read"}),l=r.participants.map(e=>e.userId===s?{...e,lastReadAt:n,lastSeenAt:n}:e),d=i.filter(e=>e.senderId!==s&&e.readBy.length<r.participants.length).length;return{messages:{...e.messages,[t]:i},conversations:{...e.conversations,[t]:{...r,participants:l,unreadCount:d}}}})},markAllAsRead:e=>{let{conversations:s}=t();Object.keys(s).forEach(s=>{t().markAsRead(s,e)})},deleteMessage:(t,s)=>{e(e=>{var n;return{messages:{...e.messages,[t]:(null===(n=e.messages[t])||void 0===n?void 0:n.map(e=>e.id===s?{...e,deletedAt:new Date,content:"[Mensagem removida]"}:e))||[]}}})},setTyping:(t,s,n)=>{e(e=>{let a=e.isTyping[t]||[],r=n?[...new Set([...a,s])]:a.filter(e=>e!==s);return{isTyping:{...e.isTyping,[t]:r}}})},setActiveConversation:t=>{e({activeConversationId:t})},getConversation:e=>t().conversations[e]||null,getMessages:e=>t().messages[e]||[],getUnreadTotal:e=>{let{conversations:s}=t();return Object.values(s).filter(t=>t.participants.some(t=>t.userId===e)).reduce((e,t)=>e+t.unreadCount,0)},getConversationsForUser:e=>{let{conversations:s}=t();return Object.values(s).filter(t=>t.participants.some(t=>t.userId===e)&&!t.isArchived).sort((e,t)=>new Date(t.updatedAt).getTime()-new Date(e.updatedAt).getTime())},getPatientCareConversation:e=>{let{conversations:s}=t();return Object.values(s).find(t=>"patient_care"===t.type&&t.patientId===e)||null},searchMessages:(e,s)=>{let{messages:n}=t(),a=e.toLowerCase();return(s?n[s]||[]:Object.values(n).flat()).filter(e=>e.content.toLowerCase().includes(a)&&!e.deletedAt)}}),{name:"maos-amigas-chat",storage:(0,a.FL)(()=>localStorage),partialize:e=>({conversations:e.conversations,messages:e.messages})}))}}]);